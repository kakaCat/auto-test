# 可视化工作流设计器用户指南

## 概述

可视化工作流设计器是AI自动化测试系统的核心功能模块，基于项目的6层架构体系设计。用户可以通过直观的可视化界面设计复杂的API调用流程和页面调用流程，将系统管理中的API接口和页面信息串联成完整的测试场景，无需编写代码即可实现自动化测试。

### 6层架构体系
```
1. 系统管理 (System Management) - 管理各个业务系统
   └── 2. 模块管理 (Module Management) - 系统下的功能模块分类
       ├── 3a. API管理 (API Management) - 记录和管理API接口信息
       ├── 3b. 页面管理 (Page Management) - 记录和管理页面信息
       │   ├── 4a. API调用流程 (API Call Flow) - 将API接口串联成调用流程
       │   └── 4b. 页面调用流程 (Page Call Flow) - 将页面操作串联成调用流程
       │       └── 5. 用例场景 (Test Scenarios) - 基于调用流程的测试案例
       │           └── 6. 需求测试 (Requirement Testing) - 需求与用例场景的关联管理
```

## 快速入门

### 1. 访问设计器

在系统主菜单中选择 **工作流编排** → **可视化设计器**，即可进入设计器界面。

### 2. 界面布局

设计器界面分为四个主要区域：

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                工具栏                                           │
│ [保存] [加载] [清空] [执行] [停止] [调试] [进度] [系统选择]                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│ 节点面板 │                        画布区域                      │ 属性面板      │
│ ┌─────┐ │ ┌─────────────────────────────────────────────────┐ │ ┌─────────┐ │
│ │🚀开始│ │ │                                                 │ │ │节点属性 │ │
│ │🏁结束│ │ │           拖拽节点到此处开始设计                │ │ │配置区域 │ │
│ │🔧API│ │ │                                                 │ │ │         │ │
│ │📊转换│ │ │                                                 │ │ │         │ │
│ │🔀分支│ │ │                                                 │ │ │         │ │
│ │⚡并行│ │ │                                                 │ │ │         │ │
│ └─────┘ │ └─────────────────────────────────────────────────┘ │ └─────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 核心功能

### 1. 节点类型

#### 🚀 开始节点 (Start Node)
- **用途**: 工作流的起始点
- **特点**: 每个工作流必须有且仅有一个开始节点
- **配置**: 无需特殊配置

#### 🏁 结束节点 (End Node)
- **用途**: 工作流的结束点
- **特点**: 可以有多个结束节点
- **配置**: 可设置返回值和状态

#### 🔧 API调用节点 (API Call Node)
- **用途**: 执行HTTP API调用，基于项目的6层架构体系
- **配置方式**: 级联选择配置
  
  **🏗️ 系统级联配置**：
  - **第1层**: 选择系统（从系统管理中配置的系统列表）
  - **第2层**: 选择模块（该系统下的功能模块分类）
  - **第3层**: 选择API接口（从API管理中记录的接口信息）
  - **自动加载**: 根据选择自动加载请求方法、路径、参数模板
  
- **参数配置**：
  - 基于选中API接口自动生成JSON参数模板
  - 支持动态参数绑定（如：${previous_node.field}）
  - 实时JSON格式验证和语法检查
  - 支持复杂嵌套对象和数组参数
  - 支持请求头配置和认证信息
  
- **执行配置**：
  - 超时设置：设置请求超时时间（默认30秒）
  - 重试配置：设置重试次数（0-5次）
  - 错误处理：继续执行/停止执行/记录并继续
  
- **流程串联**：
  - 支持将多个API调用节点串联成API调用流程
  - 数据在节点间自动传递和转换
  - 支持条件分支和并行执行

#### 📊 数据转换节点 (Data Transform Node)
- **用途**: 对数据进行转换和处理
- **转换类型**:
  - **字段映射**: 将输入字段映射到输出字段
  - **格式转换**: 转换数据格式（JSON、XML、CSV等）
  - **数据过滤**: 根据条件过滤数据
  - **数据聚合**: 对数据进行聚合计算
  - **脚本转换**: 使用JavaScript进行自定义数据转换
- **配置选项**:
  - 转换规则：定义具体的转换逻辑
  - 输入验证：验证输入数据格式
  - 错误处理：处理转换失败的情况

#### 🔀 条件分支节点 (Condition Node)
- **用途**: 根据条件进行流程分支
- **配置项**:
  - 条件表达式：设置判断条件（支持JavaScript表达式）
  - 逻辑操作符：AND、OR、NOT
  - 比较操作符：==、!=、>、<、>=、<=
  - 分支路径：设置不同条件下的执行路径
- **支持的数据类型**:
  - 字符串、数字、布尔值
  - 对象属性访问（如：user.status）
  - 数组操作（如：items.length > 0）

#### ⚡ 并行执行节点 (Parallel Node)
- **用途**: 并行执行多个分支，提高执行效率
- **配置项**:
  - 最大并发数：设置同时执行的分支数量（1-10）
  - 等待策略：
    - **全部完成**：等待所有分支执行完成
    - **任一完成**：任意一个分支完成即继续
    - **部分完成**：指定数量的分支完成即继续
  - 超时设置：设置并行执行的总超时时间
  - 失败策略：
    - **快速失败**：任一分支失败即停止所有分支
    - **容错执行**：忽略失败的分支，继续执行其他分支

### 2. 连接方式

#### 顺序连接
- 节点按顺序依次执行
- 前一个节点完成后才执行下一个节点

#### 条件连接
- 根据条件判断结果选择执行路径
- 支持多条件分支

#### 并行连接
- 多个分支同时执行
- 可设置汇聚点等待所有分支完成

## 节点面板详解

### 1. 节点分类

节点面板按功能分为以下几个主要分类：

#### 🚀 基础节点 (Basic)
- **开始节点** (start): 工作流的起始点
- **结束节点** (end): 工作流的结束点

#### 🔧 数据处理 (Data)
- **API调用节点** (api-call): 执行HTTP API调用
- **数据转换节点** (data-transform): 数据格式转换和处理

#### 🎛️ 流程控制 (Control)
- **条件分支节点** (condition): 根据条件进行流程分支
- **并行执行节点** (parallel): 并行执行多个分支
- **循环执行节点** (loop): 循环执行指定次数或条件
- **延时等待节点** (delay): 延时等待指定时间

#### 📢 通知节点 (Notification)
- **邮件通知节点** (email): 发送邮件通知
- **Webhook节点** (webhook): 发送HTTP回调通知
- **告警通知节点** (alert): 发送系统告警

#### 🧪 测试节点 (Testing)
- **断言验证节点** (assert): 验证数据是否符合预期
- **模拟数据节点** (mock): 生成模拟测试数据
- **性能测试节点** (performance): 执行性能测试

### 2. 节点搜索

节点面板顶部提供搜索功能：
- 输入关键字快速筛选节点
- 支持中文和英文搜索
- 支持节点名称和描述搜索

### 3. 拖拽操作

- 从节点面板拖拽节点到画布创建新节点
- 拖拽过程中会显示节点预览
- 释放鼠标完成节点创建

## 操作指南

### 1. 创建工作流

#### 步骤1：添加开始节点
1. 从节点面板拖拽 **🚀开始节点** 到画布
2. 开始节点会自动定位到画布左上角

#### 步骤2：添加业务节点
1. 根据业务需求从节点面板选择合适的节点类型
2. 拖拽节点到画布的合适位置
3. 双击节点或在属性面板中配置节点参数

#### 步骤3：连接节点
1. 点击源节点的输出连接点
2. 拖拽到目标节点的输入连接点
3. 系统会自动创建连接线

#### 步骤4：添加结束节点
1. 拖拽 **🏁结束节点** 到工作流末端
2. 连接最后的业务节点到结束节点

### 2. 节点配置

#### API调用节点配置示例

**🏗️ 系统级联配置示例**：

**示例1: 用户信息查询**
```
节点名称: 获取用户信息
系统级联配置:
  ├─ 第1层-系统选择: 用户管理系统
  ├─ 第2层-模块选择: 用户模块  
  └─ 第3层-API选择: 获取用户详情
      ├─ 请求方法: GET
      ├─ 请求路径: /api/users/{user_id}
      └─ 响应格式: JSON

请求参数 (JSON格式):
{
  "user_id": "${previous_node.user_id}",
  "include_profile": true,
  "fields": ["id", "name", "email", "status"]
}

请求头配置:
{
  "Authorization": "Bearer ${auth_token}",
  "Content-Type": "application/json"
}

执行配置:
  - 超时时间: 30秒
  - 重试次数: 3次
  - 错误处理: 记录并继续
```

**示例2: 订单创建流程**
```
节点名称: 创建订单
系统级联配置:
  ├─ 第1层-系统选择: 订单管理系统
  ├─ 第2层-模块选择: 订单模块
  └─ 第3层-API选择: 创建新订单
      ├─ 请求方法: POST
      ├─ 请求路径: /api/orders
      └─ 响应格式: JSON

请求参数 (JSON格式):
{
  "customer_id": "${user_node.id}",
  "items": [
    {
      "product_id": "12345",
      "quantity": 2,
      "price": 99.99
    }
  ],
  "shipping_address": {
    "street": "123 Main St",
    "city": "Beijing", 
    "country": "China"
  }
}

执行配置:
  - 超时时间: 45秒
  - 重试次数: 2次
  - 错误处理: 停止执行
```

**示例3: API调用流程串联**
```
流程名称: 完整的用户订单流程
节点串联:
  1. 用户登录验证 → 2. 获取用户信息 → 3. 创建订单 → 4. 支付处理

数据传递:
  - 登录节点输出: ${login.token}, ${login.user_id}
  - 用户信息节点: 使用 ${login.user_id} 作为输入
  - 订单创建节点: 使用 ${user_info.id} 作为customer_id
  - 支付节点: 使用 ${order.order_id} 作为订单号
```

#### 条件分支节点配置示例
```
节点名称: 用户状态判断
条件表达式: user.status == "active"
分支配置:
  - 条件为真: 继续处理流程
  - 条件为假: 发送通知并结束
```

### 3. 执行工作流

#### 手动执行
1. 点击工具栏的 **▶️ 执行** 按钮
2. 系统开始执行工作流
3. 观察节点状态变化和执行进度

#### 调试模式
1. 点击工具栏的 **🔧 调试** 按钮
2. 工作流会逐步执行，可以查看每个节点的输入输出
3. 便于排查问题和优化流程

#### 状态监控
- **🟢 运行中**: 节点正在执行
- **🔵 等待中**: 节点等待执行
- **✅ 已完成**: 节点执行成功
- **❌ 失败**: 节点执行失败
- **⏸️ 暂停**: 节点执行暂停

### 4. 保存和加载

#### 保存工作流
1. 点击工具栏的 **💾 保存** 按钮
2. 输入工作流名称和描述
3. 选择保存位置（本地或云端）

#### 加载工作流
1. 点击工具栏的 **📁 加载** 按钮
2. 从工作流列表中选择要加载的工作流
3. 工作流会在画布中重新显示

## API调用流程详解

### 1. 流程概念

API调用流程是预定义的完整API调用链路，包含了从系统选择到具体API调用的所有必要信息。与传统的单独选择系统、模块、API的方式不同，流程化的配置方式提供了更完整和一致的API调用体验。

### 2. 流程组成

每个API调用流程包含以下核心组件：

#### 基础信息
- **流程名称**: 描述性的流程标识
- **流程描述**: 详细说明流程的用途和功能
- **版本信息**: 支持流程的版本管理

#### 系统架构
- **目标系统**: 具体的后端系统（如：用户管理系统、订单系统）
- **业务模块**: 系统内的功能模块（如：用户模块、权限模块）
- **API接口**: 具体的API端点和方法

#### 技术规范
- **请求方法**: GET、POST、PUT、DELETE等
- **请求路径**: 完整的API路径，支持路径参数
- **请求头**: 必要的HTTP头信息
- **认证方式**: API认证和授权配置

#### 数据模板
- **请求参数**: 标准化的参数模板和验证规则
- **响应格式**: 预期的响应数据结构
- **错误码**: 可能的错误情况和处理方式

### 3. 流程优势

#### 标准化配置
- 统一的API调用标准，减少配置错误
- 预定义的参数模板，提高配置效率
- 版本化管理，支持API演进

#### 复用性
- 流程可在多个工作流中重复使用
- 减少重复配置工作
- 保证API调用的一致性

#### 可维护性
- 集中管理API调用配置
- 便于批量更新和维护
- 支持流程的版本控制

### 4. 使用示例

#### 完整流程配置
```yaml
流程名称: 用户信息查询流程
流程版本: v1.2.0
系统信息:
  系统名称: 用户管理系统
  模块名称: 用户模块
  API名称: 获取用户详情
技术规范:
  请求方法: GET
  请求路径: /api/v1/users/{user_id}
  认证方式: Bearer Token
  超时时间: 30秒
参数模板:
  路径参数:
    - user_id: 用户ID (必填, 数字类型)
  查询参数:
    - include_profile: 是否包含详细信息 (可选, 布尔类型, 默认: false)
    - fields: 返回字段列表 (可选, 数组类型)
响应格式:
  成功响应: 
    - code: 200
    - data: 用户对象
  错误响应:
    - code: 404 (用户不存在)
    - code: 403 (权限不足)
```

#### 节点中的使用
```
节点配置:
  节点名称: 查询用户信息
  流程选择: 用户信息查询流程 (v1.2.0)
  参数绑定:
    - user_id: ${input.user_id}
    - include_profile: true
    - fields: ["id", "name", "email", "status", "created_at"]
  执行配置:
    - 超时时间: 30秒 (继承自流程)
    - 重试次数: 3次
    - 失败处理: 记录错误日志并继续
```

## 最佳实践

### 1. 工作流设计原则

#### 单一职责原则
- 每个节点只负责一个特定的功能
- 避免在单个节点中处理过多逻辑

#### 错误处理
- 为关键节点添加错误处理逻辑
- 设置合适的重试机制和超时时间

#### 性能优化
- 合理使用并行节点提高执行效率
- 避免不必要的数据传递和转换

### 2. 常见模式

#### API调用链模式
```
🚀开始 → 🔧登录API → 🔧获取数据API → 📊数据处理 → 🏁结束
```

#### 条件分支模式
```
🚀开始 → 🔧检查状态API → 🔀状态判断
                                ├─ 正常 → 🔧处理API → 🏁结束
                                └─ 异常 → 📧发送通知 → 🏁结束
```

#### 并行处理模式
```
🚀开始 → ⚡并行节点 ├─ 🔧API调用1 ┐
                    ├─ 🔧API调用2 ├─ 📊数据汇总 → 🏁结束
                    └─ 🔧API调用3 ┘
```

### 3. 调试技巧

#### 使用断点
- 在关键节点设置断点
- 逐步执行查看数据流转

#### 日志查看
- 查看节点执行日志
- 分析错误信息和性能数据

#### 数据检查
- 检查节点间的数据传递
- 验证数据格式和内容

## 高级功能

### 1. 变量和表达式

#### 全局变量
- 定义工作流级别的全局变量
- 在任何节点中都可以访问和修改

#### 节点变量
- 每个节点可以定义局部变量
- 用于存储节点执行结果

#### 表达式语法
```javascript
// 访问前一个节点的输出
${previous_node.result}

// 访问全局变量
${global.user_id}

// 条件表达式
user.age >= 18 && user.status == "active"

// 数据转换表达式
user.name.toUpperCase()
```

### 2. 循环和迭代

#### 循环节点
- 支持for循环和while循环
- 可以遍历数组或根据条件循环

#### 迭代处理
- 对数组中的每个元素执行相同的处理逻辑
- 支持并行迭代和顺序迭代

### 3. 异常处理

#### 错误捕获
- 自动捕获节点执行异常
- 提供详细的错误信息

#### 重试机制
- 支持自动重试失败的节点
- 可配置重试次数和间隔

#### 降级处理
- 当主流程失败时执行备用流程
- 确保工作流的健壮性

## 常见问题

### Q1: 如何处理API调用超时？
**A**: 在API调用节点中设置合适的超时时间，并配置重试机制。建议超时时间设置为30-60秒，重试次数设置为2-3次。

### Q2: 如何在节点间传递复杂数据？
**A**: 使用数据转换节点对复杂数据进行格式化和映射，确保下游节点能够正确解析数据。

### Q3: 如何优化工作流执行性能？
**A**: 
- 使用并行节点同时执行独立的任务
- 减少不必要的数据转换
- 合理设置节点超时时间
- 避免在循环中执行耗时操作

### Q4: 如何调试复杂的工作流？
**A**: 
- 使用调试模式逐步执行
- 在关键节点添加日志输出
- 检查节点间的数据传递
- 使用简化的测试数据进行调试

### Q5: 如何处理并发执行的数据冲突？
**A**: 
- 避免在并行分支中修改共享数据
- 使用数据汇总节点合并并行结果
- 在必要时使用锁机制保护关键资源

## 总结

可视化工作流设计器为用户提供了强大而直观的自动化测试流程设计能力。通过拖拽式的操作界面，用户可以快速构建复杂的API调用流程，实现高效的自动化测试。

掌握本指南中的操作方法和最佳实践，您将能够：
- 快速设计和实现自动化测试流程
- 有效处理复杂的业务逻辑和数据流转
- 优化工作流性能和可维护性
- 解决常见的设计和执行问题

如需更多帮助，请参考技术文档或联系技术支持团队。