# 系统架构设计文档

## 📋 概述

本文档详细说明了AI自动化测试平台的整体系统架构、技术选型、模块设计和数据流向。

## 🏗️ 整体架构设计

### 技术架构
```
┌─────────────────────────────────────────────────────────┐
│                    前端层                               │
│  Vue 3 + TypeScript + Element Plus + Pinia             │
│  ├─ 用户界面组件                                        │
│  ├─ 状态管理                                            │
│  ├─ 路由管理                                            │
│  └─ HTTP客户端                                          │
└─────────────────┬───────────────────────────────────────┘
                  │ HTTP/REST API
┌─────────────────▼───────────────────────────────────────┐
│                    后端层                               │
│  FastAPI + Python + SQLAlchemy                         │
│  ├─ API接口层 (Controller)                             │
│  ├─ 业务逻辑层 (Service)                               │
│  ├─ 数据访问层 (Repository)                            │
│  └─ 数据模型层 (Models)                                │
└─────────────────┬───────────────────────────────────────┘
                  │ SQL
┌─────────────────▼───────────────────────────────────────┐
│                   数据层                                │
│  SQLite/PostgreSQL                                     │
│  ├─ 系统管理表                                          │
│  ├─ API管理表                                           │
│  ├─ 页面管理表                                          │
│  ├─ 工作流表                                            │
│  └─ 场景管理表                                          │
└─────────────────────────────────────────────────────────┘
```

### 前端架构详细设计
- **框架**: Vue 3 + Composition API
- **类型系统**: TypeScript (严格模式)
- **UI组件库**: Element Plus
- **状态管理**: Pinia
- **路由管理**: Vue Router
- **HTTP客户端**: Axios
- **构建工具**: Vite
- **工作流图形**: Vue Flow

### 后端架构详细设计
- **框架**: FastAPI + Python 3.9+
- **数据库**: SQLite (开发) / PostgreSQL (生产)
- **ORM**: SQLAlchemy
- **API文档**: Swagger/OpenAPI
- **架构模式**: 分层架构 (Controller → Service → Repository)
- **依赖注入**: FastAPI内置DI
- **数据验证**: Pydantic

## 🎯 业务架构设计

### 6层业务架构
```
第6层: 需求管理 (Requirement Management)
├─ 功能: 需求记录、用例关联、测试计划、执行跟踪
├─ 页面: /requirement-management
└─ 状态: ✅ 已实现

第5层: 用例场景管理 (Scenario Management)  
├─ 功能: 场景设计、测试数据、断言配置、执行策略
├─ 页面: /scenario-management
└─ 状态: ✅ 已实现

第4层: 调用流程 (Call Flows)
├─ 4a. API调用流程 (/workflow-orchestration + /designer)
│   ├─ 功能: 可视化设计器、API节点编排、流程执行
│   └─ 状态: ✅ 已实现
└─ 4b. 页面调用流程 (/page-call-flow)
    ├─ 功能: 页面操作设计器、元素交互、UI自动化
    └─ 状态: 🚧 规划中

第3层: 资源管理 (Resource Management)
├─ API管理 (/api-management): API接口管理、批量操作
├─ 页面管理 (/page-management): 页面配置、布局设计
└─ 状态: ✅ 已实现

第2层: 系统管理 (Service Management)
├─ 功能: 系统和模块的两级架构、系统注册、模块分类
├─ 页面: /service-management  
└─ 状态: ✅ 已实现

第1层: 仪表板 (Dashboard)
├─ 功能: 数据概览、统计展示、快捷入口、最近活动
├─ 页面: /dashboard
└─ 状态: ✅ 已实现
```

### 数据流向设计
```
自下而上的构建流程:
系统管理(注册系统和模块) → 资源管理(录入API和页面) → 
调用流程设计(API调用流程 + 页面调用流程) → 
用例场景管理(创建测试场景) → 需求管理(关联需求和用例)
```

## 🧩 核心模块设计

### 1. 系统管理模块

#### 前端组件结构
```
系统管理页面 (service-management/index.vue)
├── 页面头部
│   ├── 错误提示组件
│   ├── 标题和描述
│   └── 操作按钮组 (新增系统、刷新)
├── 主内容区域
│   ├── 左侧面板
│   │   ├── 系统类型筛选
│   │   └── SystemTree组件
│   └── 右侧面板
│       ├── 系统详情展示
│       ├── 模块列表
│       └── 操作按钮组
└── 对话框组件
    ├── 系统编辑对话框
    └── 模块编辑对话框
```

#### 核心组件
- **SystemTree**: 系统树形导航组件
- **ErrorAlert**: 错误提示组件  
- **系统详情面板**: 显示选中系统的详细信息

#### 操作逻辑
1. **初始化**: 页面加载时调用 `loadEnabledSystems()` 获取启用的系统列表
2. **系统筛选**: 通过类型筛选器切换显示不同分类的系统
3. **系统选择**: 点击系统树节点触发 `handleSystemSelect()` 显示系统详情
4. **系统操作**: 支持新增、编辑、删除、启用/禁用系统

### 2. API管理模块

#### 前端组件结构
```
API管理页面 (api-management/index.vue)
├── 页面头部
│   ├── 标题: "API管理"
│   ├── 描述: "管理和维护系统API接口"
│   └── 操作按钮组 (新增API、导入API、导出API)
├── 主内容区域
│   ├── 左侧面板
│   │   └── SystemTree组件 (复用)
│   └── 右侧面板
│       ├── 搜索筛选区域
│       ├── 批量操作区域
│       └── API列表展示
└── 对话框组件
    ├── API编辑对话框
    └── 参数配置对话框
```

#### 核心组件
- **SystemTree**: 系统树形导航（复用）
- **ApiFormDialog**: API创建/编辑对话框
- **ApiCard**: API信息卡片组件
- **SearchFilter**: 搜索筛选组件

### 3. 页面管理模块

#### 前端组件结构
```
页面管理页面 (page-management/index.vue)
├── 页面头部
│   ├── 标题: "页面管理"
│   ├── 描述: "管理系统页面和API关联"
│   └── 操作按钮组 (新增页面、刷新)
├── 主内容区域
│   ├── 左侧面板
│   │   └── SystemTree组件 (复用)
│   └── 右侧面板
│       ├── 搜索筛选区域
│       ├── 页面列表展示
│       └── 页面API关联管理
└── 对话框组件
    ├── 页面编辑对话框
    └── API关联对话框
```

#### 核心组件
- **SystemTree**: 系统树形导航（复用）
- **PageFormDialog**: 页面创建/编辑对话框
- **PageCard**: 页面信息卡片组件
- **PageApiManager**: 页面API关联管理组件

### 4. 工作流编排模块

#### 前端组件结构
```
工作流设计器 (workflow-orchestration/designer.vue)
├── 工具栏
│   ├── 保存/加载按钮
│   ├── 执行控制按钮
│   └── 视图操作按钮
├── 主设计区域
│   ├── 节点库面板
│   │   ├── 节点分类展示
│   │   ├── 节点搜索功能
│   │   └── 拖拽创建节点
│   ├── 画布区域
│   │   ├── Vue Flow核心
│   │   ├── 节点组件渲染
│   │   └── 连线关系管理
│   └── 属性配置面板
│       ├── 通用属性配置
│       ├── 类型特定配置
│       └── 实时验证更新
└── 状态栏
    ├── 执行状态显示
    └── 操作提示信息
```

## 🔄 数据流设计

### 标准数据流模式
```
用户操作 → 组件事件 → Composable处理 → API调用 → 数据更新 → 界面刷新
```

### 状态管理模式
```
组件本地状态 (ref/reactive) ← → Composable状态 ← → Pinia全局状态
```

### 错误处理流程
```
API错误 → HttpClient统一处理 → 用户提示 → 组件状态更新
```

## 🗄️ 数据库设计

### 核心表结构
```
systems (系统表)
├── id (主键)
├── name (系统名称)
├── description (描述)
├── category (分类: backend/frontend)
├── enabled (启用状态)
├── created_at (创建时间)
└── updated_at (更新时间)

modules (模块表)
├── id (主键)
├── system_id (外键 → systems.id)
├── name (模块名称)
├── description (描述)
├── enabled (启用状态)
├── created_at (创建时间)
└── updated_at (更新时间)

api_interfaces (API接口表)
├── id (主键)
├── system_id (外键 → systems.id)
├── module_id (外键 → modules.id)
├── name (API名称)
├── method (HTTP方法)
├── path (API路径)
├── enabled (启用状态)
├── created_at (创建时间)
└── updated_at (更新时间)

pages (页面表)
├── id (主键)
├── system_id (外键 → systems.id)
├── name (页面名称)
├── route_path (路由路径)
├── page_type (页面类型)
├── status (状态)
├── created_at (创建时间)
└── updated_at (更新时间)
```

### 表关系设计
```
systems (1) ←→ (N) modules
systems (1) ←→ (N) api_interfaces
systems (1) ←→ (N) pages
modules (1) ←→ (N) api_interfaces
```

## 🚀 技术特性

### 前端特性
- **响应式设计**: 支持桌面和移动端
- **组件化开发**: 可复用的组件体系
- **类型安全**: 完整的TypeScript支持
- **状态管理**: 统一的Pinia状态管理
- **错误处理**: 统一的错误处理机制

### 后端特性
- **RESTful API**: 标准的REST接口设计
- **自动文档**: Swagger/OpenAPI自动生成
- **数据验证**: Pydantic模型验证
- **异步支持**: FastAPI异步处理
- **分层架构**: 清晰的代码分层

### 工作流特性
- **可视化设计**: 拖拽式工作流设计器
- **节点化编排**: 模块化的节点组件
- **实时执行**: 工作流实时执行和监控
- **数据传递**: 节点间的数据流转
- **错误处理**: 完善的执行错误处理

## 📊 性能设计

### 前端性能优化
- **代码分割**: 路由级别的懒加载
- **组件缓存**: 合理使用keep-alive
- **API缓存**: 智能的数据缓存策略
- **虚拟滚动**: 大列表性能优化

### 后端性能优化
- **数据库优化**: 合理的索引设计
- **查询优化**: 避免N+1查询问题
- **缓存策略**: Redis缓存热点数据
- **异步处理**: 长时间任务异步执行

## 🛡️ 安全设计

### 认证授权
- **JWT Token**: 基于Token的认证
- **权限控制**: 基于角色的访问控制
- **API安全**: 接口权限验证

### 数据安全
- **输入验证**: 前后端双重验证
- **SQL注入防护**: ORM参数化查询
- **XSS防护**: 前端输出转义
- **CSRF防护**: CSRF Token验证

## 🔧 扩展性设计

### 模块化设计
- **插件化架构**: 支持功能模块的插拔
- **API标准化**: 统一的API设计规范
- **组件复用**: 高度可复用的组件设计
- **配置驱动**: 基于配置的功能开关

### 可扩展性
- **水平扩展**: 支持多实例部署
- **垂直扩展**: 支持功能模块扩展
- **第三方集成**: 标准化的集成接口
- **数据迁移**: 完善的数据迁移机制

---

**文档版本**: v2.0  
**最后更新**: 2024年1月  
**维护者**: 架构设计团队