# 执行文档：API 接口管理泛型改造与前端适配

## 背景与目标
- 统一后端接口返回结构为 `ApiResponseGeneric<T>`，提高前后端数据契约的一致性与可读性。
- 修正 `ApiInterface` 模型中 `request_schema/response_schema` 字段类型为对象，避免 Pydantic 校验错误。
- 前端类型与请求封装适配后端泛型结构，透传 `code` 字段，放宽 `timestamp` 为可选。

## 后端改动摘要
- 路由前缀：`/api/api-interfaces/v1/*`（同时保留兼容的 `/api/interfaces/*`）。
- 响应统一：所有接口返回 `ApiResponseGeneric<T>`，包含 `success/message/data/code/timestamp`。
- 模型修正：`ApiInterfaceBase.request_schema/response_schema: Optional[dict]`（原为 `Optional[str]`）。
- 已验证接口：
  - 列表 `GET /api/api-interfaces/v1/` → `ApiResponseGeneric<ApiInterfaceResponse>`（含 `list/total/page/size`，兼容 `apis`）。
  - 详情 `GET /api/api-interfaces/v1/{id}` → `ApiResponseGeneric<ApiInterface>`。
  - 创建 `POST /api/api-interfaces/v1/` → `ApiResponseGeneric<ApiInterface>`（含系统/模块校验）。
  - 更新 `PUT /api/api-interfaces/v1/{id}` → `ApiResponseGeneric<ApiInterface>`（状态枚举：`active/inactive/deprecated`）。
  - 删除 `DELETE /api/api-interfaces/v1/{id}` → `ApiResponseGeneric<DeleteApiInterfaceResponse>`。
  - 统计 `GET /api/api-interfaces/v1/stats/summary` → `ApiResponseGeneric<ApiInterfaceStats>`。

## 前端改动摘要
1. 类型适配（已完成）
   - `frontend/src/types/common.ts`
     - `Result<T>` 增加可选 `code?: number | string`。
     - `timestamp?: string` 改为可选以兼容后端未返回时间戳的情况。
   - `frontend/src/api/api-management.ts`
     - 将 `request_schema/response_schema` 从 `string` 改为 `Record<string, any>`。
2. 请求封装适配（已完成）
   - `frontend/src/utils/request.ts` 响应拦截器：
     - 在成功路径透传 `data.code` 到 `ApiResponse.code`。
     - 在错误路径透传 HTTP `status` 到 `ApiResponse.code`，并保留详细错误信息。

## 迁移与兼容策略
- 路由兼容：保留 `/api/interfaces/*` 旧前缀的同时，逐步迁移到 `/api/api-interfaces/v1/*`。
- 列表数据结构：新结构为 `data.apis`；如现有页面依赖 `data.list` 或直接 `data`，在调用层增加适配映射即可（建议在使用处统一做透明映射）。
- 错误码使用：前端优先读取 `response.code`，无则回退到 HTTP 状态。在 UI 层可根据 `code` 做更细粒度提示或分支处理。

## 验证步骤
1. 文档检查
   - 打开 `http://127.0.0.1:8001/docs`，检查接口 schema 是否显示 `request_schema/response_schema` 为对象。
2. 列表接口
   - `curl 'http://127.0.0.1:8001/api/api-interfaces/v1/'`：应返回 `success=true`，`data.apis` 为数组。
3. 详情接口
   - `curl 'http://127.0.0.1:8001/api/api-interfaces/v1/1'`：`data.request_schema/response_schema` 为 JSON 对象。
4. 创建接口
   - `POST /api/api-interfaces/v1/`：系统/模块匹配错误时返回 `success=false` 且带错误 `message` 与 `code`。
5. 更新接口
   - `PUT /api/api-interfaces/v1/{id}`：使用 `status=inactive` 正常；非法枚举应返回错误并带 `code`。
6. 删除与统计
   - `DELETE /api/api-interfaces/v1/{id}`：`data.deleted=true`。
   - `GET /api/api-interfaces/v1/stats/summary`：返回统计数据与 `health_score`。

## 风险与回滚
- 可能风险：
  - 前端页面若对列表数据结构有强依赖（例如直接读取 `data`），需做适配映射，否则会出现数据展示异常。
  - 第三方依赖对响应结构的自定义解析可能忽略 `code`，需统一改造。
- 回滚策略：
  - 保留旧路由与旧结构的兼容层，遇到问题可临时切回旧接口；但建议尽快完成迁移以避免技术债。

## 后续建议
- 前端在 `apiHandler` 基础上增加“列表响应适配器”，将 `data.apis` 统一映射为页面使用的 `list/total/page/pageSize`。
- 定义错误码枚举与文档，前端根据 `code` 实现更细致错误提示（如权限、校验、业务冲突）。
- 在单元测试中增加接口契约测试（TS 类型+运行期校验），确保改动后端/前端同步。

---
如需我继续统一改造列表响应的适配层或对具体页面进行迁移，请告知具体页面与数据依赖，我会直接帮你完成。